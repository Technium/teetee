$dev=1;app={ALL_UPDATE_STATES:"okay fail checking offline",start:function(){app.start=new Date;app.fetches={pending:1,fail:false};app.db=app.getConfig("db",{});app.updateTimes=app.getConfig("updateTimes",{});app.displayUpdateDate();if(app.updateRequired){setTimeout(app.checkForUpdates,10)}app.updateStat("loaded",1)},checkForUpdates:function(){if(navigator.onLine===false){markUpdateState("offline");console.log("checkForUpdates bailed - not online")}app.markUpdateState("checking");app.fetches={pending:1,fail:false};setTimeout(function(){app.fetchData("league")},$dev?1000:0)},displayUpdateDate:function(){var d=$.Enumerable.From(app.updateTimes).Select("$.Value");var b=$(".update .status .date");var c;if(d.Any()){var a=new Date(d.Max());b.text(a.toString("d"));c=(a>new Date().add(-7).day())}else{b.text("n/a");c=false}b.removeClass("good bad");b.addClass(c?"good":"bad");app.updateRequired=!c;if($dev){app.updateRequired=true}},updateStat:function(b,d,c){if("undefined"==typeof c){c=0}if("undefined"==typeof d){d=1}var a;app.updateConfig("stats",{},function(){a=app.stats[b]=(app.stats[b]||c)+d});return a},updateFinished:function(){app.displayUpdateDate();if(app.fetches.fail){app.markUpdateState("fail")}else{app.markUpdateState("okay")}},markUpdateState:function(a){console.log("update state = "+a,(new Date).getTime()-app.start);$(".update .notice").removeClass(app.ALL_UPDATE_STATES).addClass(a)},fetchData:function(c,e){var a=new Date(app.updateTimes[c]||0);if(e){a=0}var b="data/"+c+".json";var d=$.ajax(b,{headers:{"If-Modified-Since":a.toGMTString()},ifModified:true,});d.success(function(g,f){app.dataFetched(c,g,d,f)});d.error(function(g,f,h){app.dataFetchFailed(c)})},dataFetchFailed:function(a){app.fetches.pending-=1;app.fetches.fail=true;if(app.fetches.pending==0){app.updateFinished()}},dataFetched:function(c,e,d,b){if(b=="notmodified"){}else{$.extend(app.db,e);app.setConfig("db",app.db);var a=d.getResponseHeader("Last-Modified");app.updateTimes[c]=new Date(a).valueOf();app.setConfig("updateTimes",app.updateTimes)}app.fetches.pending-=1;if(app.fetches.pending==0){app.updateFinished()}},getConfig:function(a,c){var b=localStorage.getItem(a);return(null==b)?c:JSON.parse(b)},setConfig:function(a,b){localStorage.setItem(a,JSON.stringify(b))},updateConfig:function(a,b,c){if("undefined"==typeof app[a]){app[a]=app.getConfig(a,b)}c();app.setConfig(a,app[a])},};$(document).ready(app.start);